<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - SK Crackers</title>
<link rel="icon" href="./assets/logo-transparent.png">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    body {
        font-family: 'Arial', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }
    .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    .header {
        background: linear-gradient(45deg, #ff6b35, #f59e0b);
        color: white;
        padding: 30px;
        text-align: center;
    }
    .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        font-weight: bold;
    }
    .header p {
        font-size: 1.2rem;
        opacity: 0.9;
    }
    .controls {
        padding: 30px;
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        gap: 20px;
        align-items: center;
        flex-wrap: wrap;
    }
    .search-container {
        flex: 1;
        min-width: 300px;
        position: relative;
    }
    .search-input {
        width: 100%;
        padding: 15px 50px 15px 20px;
        font-size: 1.1rem;
        border: 2px solid #e5e7eb;
        border-radius: 12px;
        transition: all 0.3s ease;
        background: white;
    }
    .search-input:focus {
        outline: none;
        border-color: #ff6b35;
        box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
    }
    .search-icon {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        font-size: 1.2rem;
    }
    .stats {
        display: flex;
        gap: 20px;
        align-items: center;
    }
    .stat-item {
        background: white;
        padding: 15px 25px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        border-left: 4px solid #ff6b35;
    }
    .stat-number {
        font-size: 1.8rem;
        font-weight: bold;
        color: #1e293b;
    }
    .stat-label {
        font-size: 0.9rem;
        color: #64748b;
        margin-top: 5px;
    }
    .refresh-btn, .add-product-btn {
        background: linear-gradient(45deg, #10b981, #059669);
        color: white;
        border: none;
        padding: 15px 25px;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .refresh-btn:hover, .add-product-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
    }
    .table-container {
        padding: 30px;
        overflow-x: auto;
    }
    .orders-table, .products-admin-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }
    .orders-table th, .products-admin-table th {
        background: linear-gradient(45deg, #1e293b, #334155);
        color: white;
        padding: 20px 15px;
        text-align: left;
        font-weight: bold;
        font-size: 1rem;
    }
    .orders-table td, .products-admin-table td {
        padding: 18px 15px;
        border-bottom: 1px solid #f1f5f9;
        vertical-align: top;
    }
    .orders-table tr:hover, .products-admin-table tr:hover {
        background-color: #f8fafc;
    }
    .orders-table tr:last-child td, .products-admin-table tr:last-child td {
        border-bottom: none;
    }
    .status-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: bold;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .status-pending {
        background: #fef3c7;
        color: #92400e;
    }
    .status-confirmed {
        background: #dbeafe;
        color: #1e40af;
    }
    .status-shipped {
        background: #e0e7ff;
        color: #5b21b6;
    }
    .status-dispatched {
        background: #f3e8ff;
        color: #7c2d12;
    }
    .status-delivered {
        background: #d1fae5;
        color: #065f46;
    }
    .status-cancelled {
        background: #fee2e2;
        color: #991b1b;
    }
    .amount {
        font-weight: bold;
        color: #059669;
        font-size: 1.1rem;
    }
    .products-list {
        max-width: 250px;
        word-wrap: break-word;
        line-height: 1.4;
    }
    .product-item {
        background: #f1f5f9;
        padding: 4px 8px;
        margin: 2px 0;
        border-radius: 4px;
        font-size: 0.85rem;
        display: inline-block;
        margin-right: 5px;
    }
    .no-orders, .no-products-admin {
        text-align: center;
        padding: 60px 20px;
        color: #64748b;
    }
    .no-orders i, .no-products-admin i {
        font-size: 4rem;
        margin-bottom: 20px;
        color: #cbd5e1;
    }
    .no-orders h3, .no-products-admin h3 {
        font-size: 1.5rem;
        margin-bottom: 10px;
    }
    .loading {
        text-align: center;
        padding: 60px 20px;
        color: #64748b;
    }
    .loading i {
        font-size: 3rem;
        animation: spin 1s linear infinite;
        color: #ff6b35;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .error-message {
        background: #fee2e2;
        color: #991b1b;
        padding: 15px 20px;
        margin: 20px 30px;
        border-radius: 8px;
        border-left: 4px solid #dc2626;
    }
    /* Status Update Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
        background-color: white;
        margin: 15% auto;
        padding: 30px;
        border-radius: 15px;
        width: 400px;
        max-width: 90%;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }
    .modal-header {
        text-align: center;
        margin-bottom: 20px;
    }
    .modal-header h3 {
        color: #1e293b;
        font-size: 1.5rem;
    }
    .status-options {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 20px;
    }
    .status-option {
        padding: 12px 15px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        font-weight: bold;
    }
    .status-option:hover {
        border-color: #ff6b35;
        background: #fef3c7;
    }
    .status-option.selected {
        border-color: #ff6b35;
        background: #ff6b35;
        color: white;
    }
    .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
    }
    .modal-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .update-btn {
        background: #10b981;
        color: white;
    }
    .cancel-btn {
        background: #6b7280;
        color: white;
    }
    .modal-btn:hover {
        transform: translateY(-2px);
    }
    /* Product View Modal */
    .product-modal {
        display: none;
        position: fixed;
        z-index: 1001;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.6);
    }
    .product-modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 0;
        border-radius: 15px;
        width: 80%;
        max-width: 800px;
        max-height: 80vh;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        overflow: hidden;
    }
    .product-modal-header {
        background: linear-gradient(45deg, #ff6b35, #f59e0b);
        color: white;
        padding: 20px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .product-modal-header h3 {
        font-size: 1.5rem;
        margin: 0;
    }
    .close-product-modal {
        background: none;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 5px;
        border-radius: 50%;
        transition: all 0.3s ease;
    }
    .close-product-modal:hover {
        background: rgba(255,255,255,0.2);
    }
    .product-modal-body {
        padding: 30px;
        max-height: 60vh;
        overflow-y: auto;
    }
    .product-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        overflow: hidden;
    }
    .product-table th {
        background: linear-gradient(45deg, #1e293b, #334155);
        color: white;
        padding: 15px 12px;
        text-align: left;
        font-weight: bold;
        font-size: 0.95rem;
    }
    .product-table td {
        padding: 12px;
        border-bottom: 1px solid #e5e7eb;
        vertical-align: middle;
    }
    .product-table tr:nth-child(even) {
        background-color: #f8fafc;
    }
    .product-table tr:hover {
        background-color: #e0f2fe;
    }
    .product-name {
        font-weight: 600;
        color: #1e293b;
    }
    .product-quantity {
        background: #dbeafe;
        color: #1e40af;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: bold;
        text-align: center;
        min-width: 40px;
        display: inline-block;
    }
    .no-products {
        text-align: center;
        padding: 40px 20px;
        color: #64748b;
    }
    .no-products i {
        font-size: 3rem;
        margin-bottom: 15px;
        color: #cbd5e1;
    }
    .export-btn {
        background: linear-gradient(45deg, #10b981, #059669);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 15px;
    }
    .export-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
    }
    .view-products-btn, .edit-product-btn {
        background: linear-gradient(45deg, #3b82f6, #1d4ed8);
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 5px;
        margin-bottom: 5px;
    }
    .view-products-btn:hover, .edit-product-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    /* Add Product Modal */
    #addProductModal .modal-content, #editProductModal .modal-content {
        width: 500px;
    }
    #editProductModal .modal-content {
        margin: 5% auto;
    }
    #addProductModal .modal-content {
        margin: 0;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
    #addProductModal .form-group, #editProductModal .form-group {
        margin-bottom: 15px;
    }
    #addProductModal label, #editProductModal label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #333;
    }
    #addProductModal input[type="text"],
    #addProductModal input[type="number"],
    #addProductModal select,
    #addProductModal input[type="file"],
    #editProductModal input[type="text"],
    #editProductModal input[type="number"],
    #editProductModal select,
    #editProductModal input[type="file"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 1rem;
    }
    #addProductModal .modal-actions, #editProductModal .modal-actions {
        margin-top: 20px;
    }
    /* Image Upload Options */
    .image-upload-options {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }
    .image-option-btn {
        padding: 8px 15px;
        border: 2px solid #e5e7eb;
        border-radius: 5px;
        background: white;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
    }
    .image-option-btn.active {
        border-color: #ff6b35;
        background: #ff6b35;
        color: white;
    }
    .image-option-btn:hover {
        border-color: #ff6b35;
    }
    .image-input-container {
        display: none;
    }
    .image-input-container.active {
        display: block;
    }
    /* Sold Out Toggle */
    .sold-out-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        width: 60px;
        height: 30px;
        background-color: #ccc;
        border-radius: 15px;
        position: relative;
        transition: background-color 0.3s;
    }
    .sold-out-toggle.active {
        background-color: #10b981;
    }
    .sold-out-toggle::before {
        content: '';
        position: absolute;
        left: 3px;
        width: 24px;
        height: 24px;
        background-color: white;
        border-radius: 50%;
        transition: transform 0.3s;
    }
    .sold-out-toggle.active::before {
        transform: translateX(30px);
    }
    .sold-out-text-admin {
        font-size: 0.85rem;
        font-weight: bold;
        margin-left: 10px;
        color: #666;
    }
    .sold-out-text-admin.active {
        color: #10b981;
    }
    .sold-out-text-admin.inactive {
        color: #ff4757;
    }
    /* Toggle in modal */
    #editProductModal .sold-out-container {
        display: flex;
        align-items: center;
        margin-top: 10px;
    }
    #editProductModal .sold-out-container label {
        margin-bottom: 0;
        margin-right: 10px;
    }
    /* Delete Button */
    .delete-product-btn {
        background: linear-gradient(45deg, #ff4757, #dc3545);
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 5px;
        margin-top: 5px;
    }
    .delete-product-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(255, 71, 87, 0.3);
    }
    @media (max-width: 768px) {
        .product-modal-content {
            width: 95%;
            margin: 10% auto;
        }
        .product-modal-body {
            padding: 20px;
        }
        .product-table th,
        .product-table td {
            padding: 8px 6px;
            font-size: 0.85rem;
        }
    }
    @media (max-width: 768px) {
        .container {
            margin: 10px;
            border-radius: 10px;
        }
        .header {
            padding: 20px;
        }
        .header h1 {
            font-size: 2rem;
        }
        .controls {
            padding: 20px;
            flex-direction: column;
            align-items: stretch;
        }
        .search-container {
            min-width: auto;
        }
        .stats {
            justify-content: center;
            flex-wrap: wrap;
        }
        .table-container {
            padding: 20px;
        }
        .orders-table, .products-admin-table {
            font-size: 0.9rem;
        }
        .orders-table th, .orders-table td,
        .products-admin-table th, .products-admin-table td {
            padding: 12px 8px;
        }
        .products-list {
            max-width: 150px;
        }
        #addProductModal .modal-content, #editProductModal .modal-content {
            width: 95%;
        }
    }
    @media (max-width: 480px) {
        .header h1 {
            font-size: 1.8rem;
        }
        .stat-item {
            padding: 10px 15px;
        }
        .stat-number {
            font-size: 1.5rem;
        }
    }
   /* Category Management Styles */
.category-management {
    margin-top: 30px;
}

.category-management .header {
    background: linear-gradient(45deg, #8e44ad, #9b59b6);
    margin-top: 0;
    border-radius: 15px 15px 0 0;
}

.category-management .controls {
    border-radius: 0;
    border-bottom: 1px solid #e2e8f0;
}

.category-management .table-container {
    border-radius: 0 0 15px 15px;
}

.categories-admin-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 10px;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
}

.categories-admin-table th {
    background: linear-gradient(45deg, #8e44ad, #9b59b6);
    color: white;
    padding: 20px 15px;
    text-align: left;
    font-weight: bold;
    font-size: 1rem;
}

.categories-admin-table td {
    padding: 18px 15px;
    border-bottom: 1px solid #f1f5f9;
    vertical-align: middle;
}

.categories-admin-table tr:hover {
    background-color: #f8fafc;
}

.categories-admin-table tr:last-child td {
    border-bottom: none;
}

.delete-category-btn {
    background: linear-gradient(45deg, #e74c3c, #c0392b);
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 6px;
    font-size: 0.9rem;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 5px;
}

.delete-category-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
}

.no-categories-admin {
    text-align: center;
    padding: 60px 20px;
    color: #64748b;
}

.no-categories-admin i {
    font-size: 4rem;
    margin-bottom: 20px;
    color: #cbd5e1;
}

.no-categories-admin h3 {
    font-size: 1.5rem;
    margin-bottom: 10px;
}

.category-type-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: bold;
}

.category-predefined {
    background: #e3f2fd;
    color: #1565c0;
}

.category-custom {
    background: #f3e5f5;
    color: #7b1fa2;
}
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1><i class="fas fa-fire"></i> SK Crackers</h1>
        <p>Admin Dashboard - Order Management</p>
    </div>
            
    <div class="controls">
        <div class="search-container">
            <input
                type="text"
                id="searchInput"
                class="search-input"
                placeholder="Search by mobile number, name, or address..."
                oninput="filterOrders()"
            />
            <i class="fas fa-search search-icon"></i>
        </div>
                    
        <div class="stats">
            <div class="stat-item">
                <div class="stat-number" id="totalOrders">0</div>
                <div class="stat-label">Total Orders</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalRevenue">₹0</div>
                <div class="stat-label">Total Revenue</div>
            </div>
        </div>
                    
        <button class="refresh-btn" onclick="fetchOrders()">
            <i class="fas fa-sync-alt"></i>
            Refresh Orders
        </button>
    </div>
            
    <div class="table-container">
        <div id="loadingMessage" class="loading">
            <i class="fas fa-spinner"></i>
            <p>Loading orders...</p>
        </div>
                    
        <div id="errorMessage" class="error-message" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="errorText"></span>
        </div>
                    
        <table class="orders-table" id="ordersTable" style="display: none;">
            <thead>
                <tr>
                    <th><i class="fas fa-hashtag"></i> ID</th>
                    <th><i class="fas fa-user"></i> Customer Name</th>
                    <th><i class="fas fa-phone"></i> Mobile</th>
                    <th><i class="fas fa-map-marker-alt"></i> Address</th>
                    <th><i class="fas fa-shopping-cart"></i> Products</th>
                    <th><i class="fas fa-rupee-sign"></i> Amount</th>
                    <th><i class="fas fa-calendar"></i> Date & Time</th>
                    <th><i class="fas fa-info-circle"></i> Status</th>
                </tr>
            </thead>
            <tbody id="ordersBody">
                <!-- Orders will be populated here -->
            </tbody>
        </table>
                    
        <div id="noOrdersMessage" class="no-orders" style="display: none;">
            <i class="fas fa-inbox"></i>
            <h3>No Orders Found</h3>
            <p>No orders match your search criteria or no orders have been placed yet.</p>
        </div>
    </div>
    <!-- Product Management Section -->
    <div class="header" style="background: linear-gradient(45deg, #3b82f6, #1d4ed8); margin-top: 30px; border-radius: 15px 15px 0 0;">
        <h1><i class="fas fa-box-open"></i> Product Inventory</h1>
        <p>Manage your products and their availability</p>
    </div>
    <div class="controls" style="border-radius: 0 0 15px 15px;">
        <button class="add-product-btn" onclick="openAddProductModal()">
            <i class="fas fa-plus-circle"></i>
            Add New Product
        </button>
        <div class="search-container" style="flex: none; width: auto;">
            <input
                type="text"
                id="productSearchInput"
                class="search-input"
                placeholder="Search products..."
                oninput="filterProductsAdmin()"
            />
            <i class="fas fa-search search-icon"></i>
        </div>
    </div>
    <div class="table-container">
        <table class="products-admin-table" id="productsAdminTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Image</th>
                    <th>Name</th>
                    <th>Category</th>
                    <th>MRP (₹)</th>
                    <th>Our Price (₹)</th>
                    <th>Sold Out</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="productsAdminBody">
                <!-- Products will be populated here -->
            </tbody>
        </table>
        <div id="noProductsAdminMessage" class="no-products-admin" style="display: none;">
            <i class="fas fa-box-open"></i>
            <h3>No Products Found</h3>
            <p>No products match your search criteria or no products have been added yet.</p>
        </div>
    </div>
</div>

 <!-- Category Management Section -->
    <div class="category-management">
        <div class="header">
            <h1><i class="fas fa-tags"></i> Category Management</h1>
            <p>Manage your product categories</p>
        </div>
        <div class="controls" style="border-radius: 0 0 15px 15px;">
            <button class="refresh-btn" onclick="loadCategoriesForAdmin()">
                <i class="fas fa-sync-alt"></i>
                Refresh Categories
            </button>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="totalCustomCategories">0</div>
                    <div class="stat-label">Custom Categories</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="totalPredefinedCategories">0</div>
                    <div class="stat-label">Predefined Categories</div>
                </div>
            </div>
        </div>
        <div class="table-container">
            <table class="categories-admin-table" id="categoriesAdminTable">
                <thead>
                    <tr>
                        <th>Category Name</th>
                        <th>Type</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="categoriesAdminBody">
                    <!-- Categories will be populated here -->
                </tbody>
            </table>
            <div id="noCategoriesAdminMessage" class="no-categories-admin" style="display: none;">
                <i class="fas fa-tags"></i>
                <h3>No Custom Categories Found</h3>
                <p>Custom categories you create will appear here. Predefined categories cannot be deleted.</p>
            </div>
        </div>
    </div>
</div>

<!-- Status Update Modal -->
<div id="statusModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Update Order Status</h3>
            <p>Order ID: <span id="modalOrderId"></span></p>
        </div>
        <div class="status-options">
            <div class="status-option" data-status="Pending Payment">Pending Payment</div>
            <div class="status-option" data-status="Confirmed">Confirmed</div>
            <div class="status-option" data-status="Shipped">Shipped</div>
            <div class="status-option" data-status="Dispatched">Dispatched</div>
            <div class="status-option" data-status="Delivered">Delivered</div>
            <div class="status-option" data-status="Cancelled">Cancelled</div>
        </div>
        <div class="modal-actions">
            <button class="modal-btn update-btn" onclick="updateOrderStatus()">Update</button>
            <button class="modal-btn cancel-btn" onclick="closeStatusModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- Product View Modal (for orders) -->
<div id="productModal" class="product-modal">
    <div class="product-modal-content">
        <div class="product-modal-header">
            <div>
                <h3>Product Details</h3>
                <p style="margin: 5px 0 0 0; opacity: 0.9;">
                    Order #<span id="productModalOrderId"></span> - <span id="productModalCustomer"></span>
                </p>
            </div>
            <button class="close-product-modal" onclick="closeProductModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="product-modal-body">
            <table class="product-table" id="productTable">
                <thead>
                    <tr>
                        <th style="width: 80px;">S.No</th>
                        <th>Product Name</th>
                        <th style="width: 120px;">Quantity</th>
                    </tr>
                </thead>
                <tbody id="productTableBody">
                    <!-- Products will be populated here -->
                </tbody>
            </table>
                            
            <div id="noProductsMessage" class="no-products" style="display: none;">
                <i class="fas fa-box-open"></i>
                <h4>No Products Found</h4>
                <p>This order doesn't have any products listed.</p>
            </div>
                            
            <button class="export-btn" onclick="exportToExcel()">
                <i class="fas fa-file-excel"></i>
                Export to Excel
            </button>
        </div>
    </div>
</div>

<!-- Add Product Modal -->
<div id="addProductModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add New Product</h3>
        </div>
        <div class="form-group">
            <label for="newProductName">Product Name</label>
            <input type="text" id="newProductName" required>
        </div>
        <div class="form-group">
            <label>Image Upload Method</label>
            <div class="image-upload-options">
                <button type="button" class="image-option-btn active" onclick="toggleImageUploadMethod('url')">URL</button>
                <button type="button" class="image-option-btn" onclick="toggleImageUploadMethod('file')">Upload from System</button>
            </div>
            <div class="image-input-container active" id="urlInputContainer">
                <input type="text" id="newProductImageUrl" placeholder="Enter image URL" value="/placeholder.svg?height=200&width=280">
            </div>
            <div class="image-input-container" id="fileInputContainer">
                <input type="file" id="newProductImageFile" accept="image/*">
            </div>
        </div>
        <div class="form-group">
            <label for="newOriginalPrice">Original Price (₹)</label>
            <input type="number" id="newOriginalPrice" min="0" value="0" required>
        </div>
        <div class="form-group">
            <label for="newCurrentPrice">Our Price (₹)</label>
            <input type="number" id="newCurrentPrice" min="0" value="0" required>
        </div>
        <div class="form-group">
            <label for="newProductCategory">Category</label>
            <select id="newProductCategory" required>
               <!-- Categories will be populated dynamically --> 
            </select>
        </div>
        <div class="form-group" id="customCategoryGroup" style="display: none;">
            <label for="newCustomCategory">Custom Category</label>
            <input type="text" id="newCustomCategory" placeholder="Enter custom category">
        </div>
        <div class="modal-actions">
            <button class="modal-btn update-btn" onclick="addNewProduct()">Add Product</button>
            <button class="modal-btn cancel-btn" onclick="closeAddProductModal()">Cancel</button>
        </div>
    </div>
</div>

<!-- Edit Product Modal -->
<div id="editProductModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Edit Product</h3>
            <p>Product ID: <span id="editProductId"></span></p>
        </div>
        <div class="form-group">
            <label for="editProductName">Product Name</label>
            <input type="text" id="editProductName" required>
        </div>
        <div class="form-group">
            <label>Image Upload Method</label>
            <div class="image-upload-options">
                <button type="button" class="image-option-btn active" onclick="toggleEditImageUploadMethod('url')">URL</button>
                <button type="button" class="image-option-btn" onclick="toggleEditImageUploadMethod('file')">Upload from System</button>
            </div>
            <div class="image-input-container active" id="editUrlInputContainer">
                <input type="text" id="editProductImageUrl" placeholder="Enter image URL" required>
            </div>
            <div class="image-input-container" id="editFileInputContainer">
                <input type="file" id="editProductImageFile" accept="image/*">
            </div>
        </div>
        <div class="form-group">
            <label for="editOriginalPrice">Original Price (₹)</label>
            <input type="number" id="editOriginalPrice" min="0" required>
        </div>
        <div class="form-group">
            <label for="editCurrentPrice">Our Price (₹)</label>
            <input type="number" id="editCurrentPrice" min="0" required>
        </div>
        <div class="form-group">
            <label for="editProductCategory">Category</label>
            <select id="editProductCategory" required>
                <!-- Categories will be populated dynamically -->
            </select>
        </div>
        <div class="form-group" id="editCustomCategoryGroup" style="display: none;">
            <label for="editCustomCategory">Custom Category</label>
            <input type="text" id="editCustomCategory" placeholder="Enter custom category">
        </div>
        <div class="form-group sold-out-container">
            <label>Availability:</label>
            <div class="sold-out-toggle" id="editSoldOutToggle" onclick="toggleEditSoldOut()"></div>
            <span class="sold-out-text-admin" id="editSoldOutText">In Stock</span>
        </div>
        <div class="modal-actions">
            <button class="modal-btn update-btn" onclick="updateProduct()">Save Changes</button>
            <button class="modal-btn cancel-btn" onclick="closeEditProductModal()">Cancel</button>
        </div>
    </div>
</div>

<script>
    let allOrders = [];
    let filteredOrders = [];
    let currentOrderId = null;
    let selectedStatus = null;
    let products = [];
    let currentEditingProductId = null;
    let customCategories = [];

    // Predefined categories
    const predefinedCategories = [
        "ONE SOUND CRACKERS",
        "TWO SOUND CRACKERS",
        "BIJILI",
        "BOMBS (NAACHIAR/SRI VIJAI/RAMCO)",
        "paper bomb [Adijaal]",
        "FLOWER POTS",
        "Flower pot bombs [shineshine]",
        "Ground chakkars",
        "Special Wheels",
        "Wire chakkars [standard]",
        "Twinkling Stars",
        "Pencil Torch",
        "ROCKETS",
        "DIGITAL WALA",
        "CHILDREN NOVELTIES",
        "COLOUR FOUNTAINS",
        "COLOUR FOUNTAINS (SUNSHINE BRAND)",
        "DOUBLE STEP FOUNTAINS",
        "TRIPLE STEP FOUNTAINS",
        "MEGA FOUNTAINS",
        "FOUNTAIN WITH SKY SHOTS",
        "PEACOCK",
        "SMOKE",
        "NEW ARRIVALS",
        "MUD FLOWER POTS",
        "MINI AERIAL CHOTTA FANCY",
        "MEGA AERIAL FANCY",
        "MULTICOLOUR SHOTS",
        "FAN CAKES (NEW ARRIVALS)",
        "WHISTLING SHOTS",
        "SPARKLERS",
        "SPECIAL SPARKLERS",
        "CHILDREN'S COLOUR MATCH BOX (NET RATE)",
        "GIFT BOXES (NET RATE)"
    ];

    // Default product data (same as order.html, used if no data in localStorage)
    const defaultProducts = [
        // ONE SOUND CRACKERS
        { id: 1, name: '2 3/4" Kuruvi', image: "./img/kuruvi1.jpg", originalPrice: 30, currentPrice: 24, category: "bombs", subcategory: "ONE SOUND CRACKERS", isSoldOut: false },
        { id: 2, name: '3 1/2" Redbull / Chotta bheem', image: "./img/chotta_beema.jpg", originalPrice: 60, currentPrice: 48, category: "bombs", subcategory: "ONE SOUND CRACKERS", isSoldOut: false },
        { id: 3, name: '5" Vikram/Tiger/Jallikattu', image: "./img/jallikattu.jpg", originalPrice: 200, currentPrice: 160, category: "bombs", subcategory: "ONE SOUND CRACKERS", isSoldOut: false },
        // TWO SOUND CRACKERS
        { id: 4, name: "2 Sound", image: "./img/2sound.jpg", originalPrice: 145, currentPrice: 116, category: "bombs", subcategory: "TWO SOUND CRACKERS", isSoldOut: false },
        // BIJILI
        { id: 5, name: "Red Bijili (100 Pcs)", image: "./img/redbijili.webp", originalPrice: 135, currentPrice: 108, category: "bombs", subcategory: "BIJILI", isSoldOut: false },
        // BOMBS (NAACHIAR/SRI VIJAI/RAMCO)
        { id: 6, name: "Bullet Bomb", image: "./img/bulletbomb.jpeg", originalPrice: 145, currentPrice: 116, category: "bombs", subcategory: "BOMBS (NAACHIAR/SRI VIJAI/RAMCO)", isSoldOut: false },
        { id: 7, name: "Hydro Bomb", image: "./img/hyderbomb.webp", originalPrice: 325, currentPrice: 260, category: "bombs", subcategory: "BOMBS (NAACHIAR/SRI VIJAI/RAMCO)", isSoldOut: false },
        { id: 8, name: "King of King Bomb", image: "./img/kingofking.webp", originalPrice: 395, currentPrice: 316, category: "bombs", subcategory: "BOMBS (NAACHIAR/SRI VIJAI/RAMCO)", isSoldOut: false },
        { id: 9, name: "Mega Flash", image: "./img/megaflash.png", originalPrice: 625, currentPrice: 500, category: "bombs", subcategory: "BOMBS (NAACHIAR/SRI VIJAI/RAMCO)", isSoldOut: false },
        { id: 10, name: "555 Bomb", image: "./img/555bomb.jpg", originalPrice: 550, currentPrice: 440, category: "bombs", subcategory: "BOMBS (NAACHIAR/SRI VIJAI/RAMCO)", isSoldOut: false },
        // Add more products as needed...
    ];

    // Load custom categories from localStorage
    function loadCustomCategories() {
        const savedCustomCategories = localStorage.getItem('skCrackersCustomCategories');
        if (savedCustomCategories) {
            customCategories = JSON.parse(savedCustomCategories);
        } else {
            customCategories = [];
        }
        console.log('Loaded custom categories:', customCategories);
    }

    // Save custom categories to localStorage
    function saveCustomCategories() {
        localStorage.setItem('skCrackersCustomCategories', JSON.stringify(customCategories));
        console.log('Saved custom categories:', customCategories);
        // Trigger storage event for other pages
        window.dispatchEvent(new StorageEvent('storage', {
            key: 'skCrackersCustomCategories',
            newValue: JSON.stringify(customCategories)
        }));
    }

    // Get all categories (predefined + custom)
    function getAllCategories() {
        const allCategories = [...predefinedCategories, ...customCategories];
        console.log('All categories:', allCategories);
        return allCategories;
    }

    // Populate category dropdown
    function populateCategoryDropdown(selectElement) {
        const allCategories = getAllCategories();
        selectElement.innerHTML = '';
        
        // Add all categories
        allCategories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            selectElement.appendChild(option);
        });
        
        // Add "Other" option at the end
        const otherOption = document.createElement('option');
        otherOption.value = 'other';
        otherOption.textContent = 'Other (Type your own)';
        selectElement.appendChild(otherOption);
        
        console.log('Populated dropdown with', allCategories.length, 'categories');
    }

    // Add custom category if it doesn't exist
    function addCustomCategory(categoryName) {
        const trimmedCategory = categoryName.trim();
        if (trimmedCategory && 
            !predefinedCategories.includes(trimmedCategory) && 
            !customCategories.includes(trimmedCategory)) {
            customCategories.push(trimmedCategory);
            saveCustomCategories();
            // Update all category dropdowns immediately
            updateAllCategoryDropdowns();
            console.log('Added new custom category:', trimmedCategory);
            return true;
        }
        return false;
    }

    // Update all category dropdowns
    function updateAllCategoryDropdowns() {
        const newProductCategory = document.getElementById('newProductCategory');
        const editProductCategory = document.getElementById('editProductCategory');
        
        if (newProductCategory) {
            const currentValue = newProductCategory.value;
            populateCategoryDropdown(newProductCategory);
            if (currentValue && currentValue !== 'other') {
                newProductCategory.value = currentValue;
            }
        }
        
        if (editProductCategory) {
            const currentValue = editProductCategory.value;
            populateCategoryDropdown(editProductCategory);
            if (currentValue && currentValue !== 'other') {
                editProductCategory.value = currentValue;
            }
        }
        
        console.log('Updated all category dropdowns');
    }

    // Fetch orders from backend
    function fetchOrders() {
        const loadingMessage = document.getElementById('loadingMessage');
        const errorMessage = document.getElementById('errorMessage');
        const ordersTable = document.getElementById('ordersTable');
        const noOrdersMessage = document.getElementById('noOrdersMessage');
                    
        // Show loading
        loadingMessage.style.display = 'block';
        errorMessage.style.display = 'none';
        ordersTable.style.display = 'none';
        noOrdersMessage.style.display = 'none';
                   
        fetch("http://localhost/sk-crackers-backend/api/orders")
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                console.log("✅ Orders fetched:", data);
                allOrders = data;
                filteredOrders = [...allOrders];
                displayOrders();
                updateStats();
                loadingMessage.style.display = 'none';
                                    
                if (data.length === 0) {
                    noOrdersMessage.style.display = 'block';
                } else {
                    ordersTable.style.display = 'table';
                }
            })
            .catch(err => {
                console.error("❌ Failed to load orders:", err);
                loadingMessage.style.display = 'none';
                errorMessage.style.display = 'block';
                document.getElementById('errorText').textContent =
                    `Failed to load orders: ${err.message}. Please check if the backend server is running on port 8081.`;
            });
    }

    // Display orders in table
    function displayOrders() {
        const tbody = document.getElementById("ordersBody");
        const ordersTable = document.getElementById('ordersTable');
        const noOrdersMessage = document.getElementById('noOrdersMessage');
                    
        tbody.innerHTML = "";
                    
        if (filteredOrders.length === 0) {
            ordersTable.style.display = 'none';
            noOrdersMessage.style.display = 'block';
            return;
        }
                    
        ordersTable.style.display = 'table';
        noOrdersMessage.style.display = 'none';
                    
        filteredOrders.forEach(order => {
            const row = document.createElement("tr");
                            
            // Format date
            const orderDate = new Date(order.dateTime);
            const formattedDate = orderDate.toLocaleDateString('en-IN', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
            const formattedTime = orderDate.toLocaleTimeString('en-IN', {
                hour: '2-digit',
                minute: '2-digit'
            });
                            
            // Format products with view button
            const productsDisplay = (order.productList && order.productList.length > 0)
                 ? `<button class="view-products-btn" onclick="openProductModal(${order.id}, '${order.customerName}', ${JSON.stringify(order.productList).replace(/"/g, '&quot;')})">
                    <i class="fas fa-eye"></i> View Products (${order.productList.length})
                   </button>`
                : '<span style="color: #64748b; font-style: italic;">No products</span>';
                            
            // Status badge
            const statusClass = getStatusClass(order.status);
                            
            row.innerHTML = `
                <td><strong>#${order.id}</strong></td>
                <td><strong>${order.customerName}</strong></td>
                <td>
                    <i class="fas fa-phone" style="color: #10b981; margin-right: 5px;"></i>
                    +91 ${order.mobileNo}
                </td>
                <td>${order.customerAddress}</td>
                <td class="products-list">${productsDisplay}</td>
                <td class="amount">₹${order.amount.toFixed(2)}</td>
                <td>
                    <div>${formattedDate}</div>
                    <small style="color: #64748b;">${formattedTime}</small>
                </td>
                <td>
                    <span class="status-badge ${statusClass}" onclick="openStatusModal(${order.id}, '${order.status}')">${order.status}</span>
                </td>
            `;
                            
            tbody.appendChild(row);
        });
    }

    // Get status class for styling
    function getStatusClass(status) {
        switch (status?.toLowerCase()) {
            case 'pending payment':
            case 'pending':
                return 'status-pending';
            case 'confirmed':
                return 'status-confirmed';
            case 'shipped':
                return 'status-shipped';
            case 'dispatched':
                return 'status-dispatched';
            case 'delivered':
                return 'status-delivered';
            case 'cancelled':
                return 'status-cancelled';
            default:
                return 'status-pending';
        }
    }

    // Update statistics
    function updateStats() {
        const totalOrders = allOrders.length;
        const totalRevenue = allOrders.reduce((sum, order) => sum + (order.amount || 0), 0);
                    
        document.getElementById('totalOrders').textContent = totalOrders;
        document.getElementById('totalRevenue').textContent = `₹${totalRevenue.toFixed(2)}`;
    }

    // Filter orders based on search input
    function filterOrders() {
        const searchTerm = document.getElementById("searchInput").value.toLowerCase().trim();
                    
        if (searchTerm === "") {
            filteredOrders = [...allOrders];
        } else {
            filteredOrders = allOrders.filter(order =>
                order.customerName.toLowerCase().includes(searchTerm) ||
                order.mobileNo.includes(searchTerm) ||
                order.customerAddress.toLowerCase().includes(searchTerm) ||
                (order.productList || []).some(product =>
                     product.toLowerCase().includes(searchTerm)
                )
            );
        }
                    
        displayOrders();
    }

    // Status Modal Functions
    function openStatusModal(orderId, currentStatus) {
        currentOrderId = orderId;
        selectedStatus = currentStatus;
                    
        document.getElementById('modalOrderId').textContent = orderId;
        document.getElementById('statusModal').style.display = 'block';
                    
        // Reset selections
        document.querySelectorAll('.status-option').forEach(option => {
            option.classList.remove('selected');
            if (option.dataset.status === currentStatus) {
                option.classList.add('selected');
            }
        });
    }

    function closeStatusModal() {
        document.getElementById('statusModal').style.display = 'none';
        currentOrderId = null;
        selectedStatus = null;
    }

    // Status option selection
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.status-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.status-option').forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                selectedStatus = this.dataset.status;
            });
        });
    });

    // Update order status
    function updateOrderStatus() {
        if (!currentOrderId || !selectedStatus) {
            alert('Please select a status');
            return;
        }

        fetch(`http://localhost/sk-crackers-backend/api/orders/${currentOrderId}/status`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: selectedStatus })
        })
        .then(res => res.json())
        .then(data => {
            console.log('Status updated:', data);
            closeStatusModal();
            fetchOrders(); // Refresh the orders
            alert('Order status updated successfully!');
        })
        .catch(err => {
            console.error('Error updating status:', err);
            alert('Failed to update status. Please try again.');
        });
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        const statusModal = document.getElementById('statusModal');
        const productModal = document.getElementById('productModal');
        const addProductModal = document.getElementById('addProductModal');
        const editProductModal = document.getElementById('editProductModal');
        if (event.target === statusModal) {
            closeStatusModal();
        }
        if (event.target === productModal) {
            closeProductModal();
        }
        if (event.target === addProductModal) {
            closeAddProductModal();
        }
        if (event.target === editProductModal) {
            closeEditProductModal();
        }
    }

    // Product Modal Functions (for orders)
    function openProductModal(orderId, customerName, productList) {
        document.getElementById('productModalOrderId').textContent = orderId;
        document.getElementById('productModalCustomer').textContent = customerName;
                    
        const tbody = document.getElementById('productTableBody');
        tbody.innerHTML = '';
                    
        if (productList && productList.length > 0) {
            productList.forEach((product, index) => {
                // Parse product string to extract name and quantity
                const productParts = product.split(' x ');
                const productName = productParts[0] || product;
                const quantity = productParts[1] || '1';
                                    
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td class="product-name">${productName}</td>
                    <td><span class="product-quantity">${quantity}</span></td>
                `;
                tbody.appendChild(row);
            });
                            
            document.getElementById('productTable').style.display = 'table';
            document.getElementById('noProductsMessage').style.display = 'none';
        } else {
            document.getElementById('productTable').style.display = 'none';
            document.getElementById('noProductsMessage').style.display = 'block';
        }
        document.getElementById('productModal').style.display = 'block';
    }

    function closeProductModal() {
        document.getElementById('productModal').style.display = 'none';
    }

    function exportToExcel() {
        const orderId = document.getElementById('productModalOrderId').textContent;
        const customerName = document.getElementById('productModalCustomer').textContent;
        const table = document.getElementById('productTable');
                    
        if (!table || table.style.display === 'none') {
            alert('No products to export');
            return;
        }
                    
        // Create CSV content
        let csvContent = `Order ID: ${orderId}\nCustomer: ${customerName}\n\n`;
        csvContent += "S.No,Product Name,Quantity\n";
                    
        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            const rowData = Array.from(cells).map(cell => {
                // Clean the text content
                return cell.textContent.trim().replace(/,/g, ';');
            });
            csvContent += rowData.join(',') + '\n';
        });
                    
        // Create and download file
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `Order_${orderId}_Products.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // Product Management Functions
    function loadProductsForAdmin() {
        const savedProducts = localStorage.getItem('skCrackersProducts');
        if (savedProducts) {
            products = JSON.parse(savedProducts);
        } else {
            products = defaultProducts;
            saveProductsForAdmin();
        }
        displayProductsForAdmin(products);
    }

    function saveProductsForAdmin() {
        localStorage.setItem('skCrackersProducts', JSON.stringify(products));
        window.dispatchEvent(new Event('storage'));
    }

    function displayProductsForAdmin(productsToShow) {
        const tbody = document.getElementById('productsAdminBody');
        const productsAdminTable = document.getElementById('productsAdminTable');
        const noProductsAdminMessage = document.getElementById('noProductsAdminMessage');

        tbody.innerHTML = '';

        if (productsToShow.length === 0) {
            productsAdminTable.style.display = 'none';
            noProductsAdminMessage.style.display = 'block';
            return;
        }

        productsAdminTable.style.display = 'table';
        noProductsAdminMessage.style.display = 'none';

        productsToShow.forEach(product => {
            const row = document.createElement('tr');
            const soldOutClass = product.isSoldOut ? 'active' : '';
            const soldOutText = product.isSoldOut ? 'Sold Out' : 'In Stock';

            row.innerHTML = `
                <td>${product.id}</td>
                <td><img src="${product.image}" alt="${product.name}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;"></td>
                <td>${product.name}</td>
                <td>${product.subcategory}</td>
                <td>₹${product.originalPrice}</td>
                <td>₹${product.currentPrice}</td>
                <td>
                    <div class="sold-out-toggle ${soldOutClass}" onclick="toggleSoldOut(${product.id})"></div>
                    <span class="sold-out-text-admin ${product.isSoldOut ? 'inactive' : 'active'}">${soldOutText}</span>
                </td>
                <td>
                    <button class="edit-product-btn" onclick="openEditProductModal(${product.id})">
                        <i class="fas fa-edit"></i> Edit
                    </button>
                    <button class="delete-product-btn" onclick="deleteProduct(${product.id})">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    function toggleSoldOut(productId) {
        const productIndex = products.findIndex(p => p.id === productId);
        if (productIndex > -1) {
            products[productIndex].isSoldOut = !products[productIndex].isSoldOut;
            saveProductsForAdmin();
            displayProductsForAdmin(products);
        }
    }

    function filterProductsAdmin() {
        const searchTerm = document.getElementById("productSearchInput").value.toLowerCase().trim();
        let filtered = products.filter(product =>
            product.name.toLowerCase().includes(searchTerm) ||
            product.subcategory.toLowerCase().includes(searchTerm)
        );
        displayProductsForAdmin(filtered);
    }

    // Delete product function
    function deleteProduct(productId) {
        if (confirm("Are you sure you want to delete this product? This action cannot be undone.")) {
            const productIndex = products.findIndex(p => p.id === productId);
            if (productIndex > -1) {
                products.splice(productIndex, 1);
                saveProductsForAdmin();
                displayProductsForAdmin(products);
                alert('Product deleted successfully!');
            }
        }
    }

    // Image upload method toggle functions
    function toggleImageUploadMethod(method) {
        const urlBtn = document.querySelector('#addProductModal .image-option-btn:first-child');
        const fileBtn = document.querySelector('#addProductModal .image-option-btn:last-child');
        const urlContainer = document.getElementById('urlInputContainer');
        const fileContainer = document.getElementById('fileInputContainer');

        if (method === 'url') {
            urlBtn.classList.add('active');
            fileBtn.classList.remove('active');
            urlContainer.classList.add('active');
            fileContainer.classList.remove('active');
        } else {
            fileBtn.classList.add('active');
            urlBtn.classList.remove('active');
            fileContainer.classList.add('active');
            urlContainer.classList.remove('active');
        }
    }

    function toggleEditImageUploadMethod(method) {
        const urlBtn = document.querySelector('#editProductModal .image-option-btn:first-child');
        const fileBtn = document.querySelector('#editProductModal .image-option-btn:last-child');
        const urlContainer = document.getElementById('editUrlInputContainer');
        const fileContainer = document.getElementById('editFileInputContainer');

        if (method === 'url') {
            urlBtn.classList.add('active');
            fileBtn.classList.remove('active');
            urlContainer.classList.add('active');
            fileContainer.classList.remove('active');
        } else {
            fileBtn.classList.add('active');
            urlBtn.classList.remove('active');
            fileContainer.classList.add('active');
            urlContainer.classList.remove('active');
        }
    }

    // Handle file to base64 conversion
    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }

    // Add Product Modal Functions
    function openAddProductModal() {
        document.getElementById('addProductModal').style.display = 'block';
        // Clear form fields
        document.getElementById('newProductName').value = '';
        document.getElementById('newProductImageUrl').value = '/placeholder.svg?height=200&width=280';
        document.getElementById('newProductImageFile').value = '';
        document.getElementById('newOriginalPrice').value = '0';
        document.getElementById('newCurrentPrice').value = '0';
        document.getElementById('newProductCategory').value = 'ONE SOUND CRACKERS';
        document.getElementById('newCustomCategory').value = '';
        document.getElementById('customCategoryGroup').style.display = 'none';
        
        // Populate category dropdown and set default
        populateCategoryDropdown(document.getElementById('newProductCategory'));
        if (predefinedCategories.length > 0) {
            document.getElementById('newProductCategory').value = predefinedCategories[0];
        }

        // Reset image upload method
        toggleImageUploadMethod('url');
    }

    function closeAddProductModal() {
        document.getElementById('addProductModal').style.display = 'none';
    }

    // Handle category change for add product AND EDIT PRODUCT
    document.addEventListener('DOMContentLoaded', function() {
        const newProductCategory = document.getElementById('newProductCategory');
        if (newProductCategory) {
            newProductCategory.addEventListener('change', function() {
                const customCategoryGroup = document.getElementById('customCategoryGroup');
                if (this.value === 'other') {
                    customCategoryGroup.style.display = 'block';
                } else {
                    customCategoryGroup.style.display = 'none';
                }
            });
        }

        const editProductCategory = document.getElementById('editProductCategory');
        if (editProductCategory) {
            editProductCategory.addEventListener('change', function() {
                const editCustomCategoryGroup = document.getElementById('editCustomCategoryGroup');
                if (this.value === 'other') {
                    editCustomCategoryGroup.style.display = 'block';
                } else {
                    editCustomCategoryGroup.style.display = 'none';
                }
            });
        }
    });

    async function addNewProduct() {
        const name = document.getElementById('newProductName').value.trim();
        const originalPrice = parseFloat(document.getElementById('newOriginalPrice').value);
        const currentPrice = parseFloat(document.getElementById('newCurrentPrice').value);
        const category = document.getElementById('newProductCategory').value;
        const customCategory = document.getElementById('newCustomCategory').value.trim();

       let subcategory;
        if (category === 'other') {
            if (!customCategory) {
                alert('Please enter a custom category.');
                return;
            }
            subcategory = customCategory;
            // Add the custom category to our list and update dropdowns
            addCustomCategory(customCategory);
        } else {
            subcategory = category;
        }

        // Handle image
        let image;
        const urlContainer = document.getElementById('urlInputContainer');
        if (urlContainer.classList.contains('active')) {
            image = document.getElementById('newProductImageUrl').value.trim();
        } else {
            const fileInput = document.getElementById('newProductImageFile');
            if (fileInput.files.length > 0) {
                try {
                    image = await fileToBase64(fileInput.files[0]);
                } catch (error) {
                    alert('Error processing image file.');
                    return;
                }
            } else {
                alert('Please select an image file.');
                return;
            }
        }

        if (!name || !image || isNaN(originalPrice) || isNaN(currentPrice) || !subcategory) {
            alert('Please fill in all product details correctly.');
            return;
        }

        const newProductId = products.length > 0 ? Math.max(...products.map(p => p.id)) + 1 : 1;
        const newProduct = {
            id: newProductId,
            name,
            image,
            originalPrice,
            currentPrice,
            category: "general", // Set a general category for internal use
            subcategory,
            isSoldOut: false
        };

        products.push(newProduct);
        saveProductsForAdmin();
        displayProductsForAdmin(products);
        closeAddProductModal();
        alert('Product added successfully!');
    }

    // Edit Product Modal Functions
    function openEditProductModal(productId) {
        currentEditingProductId = productId;
        const product = products.find(p => p.id === productId);
        if (!product) {
            alert('Product not found!');
            return;
        }

        document.getElementById('editProductId').textContent = product.id;
        document.getElementById('editProductName').value = product.name;
        document.getElementById('editProductImageUrl').value = product.image;
        document.getElementById('editOriginalPrice').value = product.originalPrice;
        document.getElementById('editCurrentPrice').value = product.currentPrice;
        
         // Populate category dropdown
        populateCategoryDropdown(document.getElementById('editProductCategory'));

        // Handle category selection
        const categorySelect = document.getElementById('editProductCategory');
        const editCustomCategoryGroup = document.getElementById('editCustomCategoryGroup');
        const editCustomCategory = document.getElementById('editCustomCategory');
        
         // Check if subcategory exists in all categories (predefined + custom)
        const allCategories = getAllCategories();
        const categoryExists = allCategories.includes(product.subcategory);
        
        if (categoryExists) {
            categorySelect.value = product.subcategory;
            editCustomCategoryGroup.style.display = 'none';
        } else {
            categorySelect.value = 'other';
            editCustomCategory.value = product.subcategory;
            editCustomCategoryGroup.style.display = 'block';
        }

        // Set the sold out toggle state
        const editSoldOutToggle = document.getElementById('editSoldOutToggle');
        const editSoldOutText = document.getElementById('editSoldOutText');
        if (product.isSoldOut) {
            editSoldOutToggle.classList.add('active');
            editSoldOutText.textContent = 'Sold Out';
            editSoldOutText.classList.remove('active');
            editSoldOutText.classList.add('inactive');
        } else {
            editSoldOutToggle.classList.remove('active');
            editSoldOutText.textContent = 'In Stock';
            editSoldOutText.classList.remove('inactive');
            editSoldOutText.classList.add('active');
        }

        // Reset image upload method
        toggleEditImageUploadMethod('url');

        document.getElementById('editProductModal').style.display = 'block';
    }

    function closeEditProductModal() {
        document.getElementById('editProductModal').style.display = 'none';
        currentEditingProductId = null;
    }

    function toggleEditSoldOut() {
        const editSoldOutToggle = document.getElementById('editSoldOutToggle');
        const editSoldOutText = document.getElementById('editSoldOutText');
        const isCurrentlySoldOut = editSoldOutToggle.classList.contains('active');

        if (isCurrentlySoldOut) {
            editSoldOutToggle.classList.remove('active');
            editSoldOutText.textContent = 'In Stock';
            editSoldOutText.classList.remove('inactive');
            editSoldOutText.classList.add('active');
        } else {
            editSoldOutToggle.classList.add('active');
            editSoldOutText.textContent = 'Sold Out';
            editSoldOutText.classList.remove('active');
            editSoldOutText.classList.add('inactive');
        }
    }

    async function updateProduct() {
        if (currentEditingProductId === null) {
            alert('No product selected for editing.');
            return;
        }

        const productIndex = products.findIndex(p => p.id === currentEditingProductId);
        if (productIndex === -1) {
            alert('Product not found in inventory.');
            return;
        }

        const name = document.getElementById('editProductName').value.trim();
        const originalPrice = parseFloat(document.getElementById('editOriginalPrice').value);
        const currentPrice = parseFloat(document.getElementById('editCurrentPrice').value);
        const category = document.getElementById('editProductCategory').value;
        const customCategory = document.getElementById('editCustomCategory').value.trim();
        const isSoldOut = document.getElementById('editSoldOutToggle').classList.contains('active');

         let subcategory;
        if (category === 'other') {
            if (!customCategory) {
                alert('Please enter a custom category.');
                return;
            }
            subcategory = customCategory;
            // Add the custom category to our list and update dropdowns
            addCustomCategory(customCategory);
        } else {
            subcategory = category;
        }


        // Handle image
        let image;
        const urlContainer = document.getElementById('editUrlInputContainer');
        if (urlContainer.classList.contains('active')) {
            image = document.getElementById('editProductImageUrl').value.trim();
        } else {
            const fileInput = document.getElementById('editProductImageFile');
            if (fileInput.files.length > 0) {
                try {
                    image = await fileToBase64(fileInput.files[0]);
                } catch (error) {
                    alert('Error processing image file.');
                    return;
                }
            } else {
                // Keep existing image if no new file selected
                image = products[productIndex].image;
            }
        }

        if (!name || !image || isNaN(originalPrice) || isNaN(currentPrice) || !subcategory) {
            alert('Please fill in all product details correctly.');
            return;
        }

        products[productIndex] = {
            ...products[productIndex],
            name,
            image,
            originalPrice,
            currentPrice,
            subcategory,
            isSoldOut
        };

        saveProductsForAdmin();
        displayProductsForAdmin(products);
        closeEditProductModal();
        alert('Product updated successfully!');
    }

    // Category Management Functions
function loadCategoriesForAdmin() {
    const tbody = document.getElementById('categoriesAdminBody');
    const categoriesAdminTable = document.getElementById('categoriesAdminTable');
    const noCategoriesAdminMessage = document.getElementById('noCategoriesAdminMessage');
    
    tbody.innerHTML = '';
    
    // Get all categories
    const allCategories = getAllCategories();
    
    if (allCategories.length === 0) {
        categoriesAdminTable.style.display = 'none';
        noCategoriesAdminMessage.style.display = 'block';
        return;
    }
    
    categoriesAdminTable.style.display = 'table';
    noCategoriesAdminMessage.style.display = 'none';
    
    // Display predefined categories (non-deletable)
    predefinedCategories.forEach(category => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${category}</td>
            <td><span class="category-type-badge category-predefined">Predefined</span></td>
            <td><span style="color: #64748b; font-style: italic;">Cannot be deleted</span></td>
        `;
        tbody.appendChild(row);
    });
    
    // Display custom categories (deletable)
    customCategories.forEach(category => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${category}</td>
            <td><span class="category-type-badge category-custom">Custom</span></td>
            <td>
                <button class="delete-category-btn" onclick="deleteCustomCategory('${category}')">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Update stats
    document.getElementById('totalCustomCategories').textContent = customCategories.length;
    document.getElementById('totalPredefinedCategories').textContent = predefinedCategories.length;
}

function deleteCustomCategory(categoryName) {
    if (confirm(`Are you sure you want to delete the category "${categoryName}"?\n\nThis action cannot be undone and will remove the category from all dropdowns.`)) {
        // Remove from custom categories array
        const categoryIndex = customCategories.indexOf(categoryName);
        if (categoryIndex > -1) {
            customCategories.splice(categoryIndex, 1);
            saveCustomCategories();
            
            // Update all category dropdowns immediately
            updateAllCategoryDropdowns();
            
            // Refresh the category management display
            loadCategoriesForAdmin();
            
            // Show success message
            alert(`Category "${categoryName}" has been deleted successfully!`);
            
            console.log('Deleted custom category:', categoryName);
            console.log('Remaining custom categories:', customCategories);
        }
    }
}
   // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        loadCustomCategories();
        fetchOrders();
        loadProductsForAdmin();
        loadCategoriesForAdmin(); 
                    
        // Auto-refresh orders every 30 seconds
        setInterval(fetchOrders, 30000);
    });
    // Add keyboard shortcut for refresh (Ctrl+R or F5)
    document.addEventListener('keydown', function(e) {
        if ((e.ctrlKey && e.key === 'r') || e.key === 'F5') {
            e.preventDefault();
            fetchOrders();
            loadProductsForAdmin();
        }
    });
</script>
</body>
</html>
